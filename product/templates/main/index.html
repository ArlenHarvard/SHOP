{% extends 'base.html' %}
{% load static %}
{% block content %}
<!-- Баннер -->
<div class="banner-wrapper bg-light">
    <div id="index_banner" class="banner-vertical-center-index container-fluid pt-5">
        <!-- Слайдер -->
        <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
            <ol class="carousel-indicators">
                <li data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active"></li>
                <li data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1"></li>
                <li data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2"></li>
            </ol>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <div class="py-5 row d-flex align-items-center">
                        <div class="banner-content col-lg-8 col-8 offset-2 m-lg-auto text-left py-5 pb-5">
                            <h1 class="banner-heading h1 text-secondary display-3 mb-0 pb-5">
                                Найдите <strong>квартиру</strong> вашей мечты
                            </h1>
                            <p class="banner-body text-muted py-3">
                                Мы предлагаем широкий выбор квартир в разных районах города —
                                от уютных студий до просторных апартаментов.
                            </p>
                            <a class="banner-button btn rounded-pill btn-outline-primary btn-lg px-4" href="#" role="button">Смотреть квартиры</a>
                        </div>
                    </div>
                </div>
                <div class="carousel-item">
                    <div class="py-5 row d-flex align-items-center">
                        <div class="banner-content col-lg-8 col-8 offset-2 m-lg-auto text-left py-5 pb-5">
                            <h1 class="banner-heading h1 text-secondary display-3 mb-0 pb-3">
                                Продажа и аренда квартир
                            </h1>
                            <p class="banner-body text-muted py-3">
                                Мы поможем вам купить или арендовать жильё по выгодной цене.
                                Надёжные застройщики, проверенные объекты.
                            </p>
                            <a class="banner-button btn rounded-pill btn-outline-primary btn-lg px-4" href="#" role="button">Подробнее</a>
                        </div>
                    </div>
                </div>
                <div class="carousel-item">
                    <div class="py-5 row d-flex align-items-center">
                        <div class="banner-content col-lg-8 col-8 offset-2 m-lg-auto text-left py-5 pb-5">
                            <h1 class="banner-heading h1 text-secondary display-3 mb-0 pb-3">
                                Уют и комфорт для вашей семьи
                            </h1>
                            <p class="banner-body text-muted py-3">
                                Подберите квартиру рядом с парками, школами и магазинами.
                                Мы заботимся о том, чтобы ваш выбор был максимально удобным.
                            </p>
                            <a class="banner-button btn rounded-pill btn-outline-primary btn-lg px-4" href="#" role="button">Выбрать квартиру</a>
                        </div>
                    </div>
                </div>
            </div>
            <a class="carousel-control-prev text-decoration-none" href="#carouselExampleIndicators" role="button" data-bs-slide="prev">
                <i class='bx bx-chevron-left'></i>
                <span class="visually-hidden">Назад</span>
            </a>
            <a class="carousel-control-next text-decoration-none" href="#carouselExampleIndicators" role="button" data-bs-slide="next">
                <i class='bx bx-chevron-right'></i>
                <span class="visually-hidden">Вперёд</span>
            </a>
        </div>
        <!-- Конец слайдера -->
    </div>
</div>
<!-- Конец Баннера -->

<!-- Блок «О нас» -->
<section class="bg-secondary">
    <div class="container py-5">
        <div class="row d-flex justify-content-center text-center">
            <div class="col-lg-2 col-12 text-light align-items-center">
                <i class='display-1 bx bxs-home bx-lg'></i>
            </div>
            <div class="col-lg-7 col-12 text-light pt-2">
                <h3 class="h4 light-300">Мы помогаем найти жильё</h3>
                <p class="light-300">Тысячи довольных клиентов уже приобрели квартиры с нашей помощью.</p>
            </div>
            <div class="col-lg-3 col-12 pt-4">
                <a href="#" class="btn btn-primary rounded-pill btn-block shadow px-4 py-2">Наши предложения</a>
            </div>
        </div>
    </div>
</section>

<!-- Категории -->
<section class="py-5 mb-5">
    <div class="container">
        <div class="recent-work-header row text-center pb-5">
            <h2 class="col-md-6 m-auto h2 semi-bold-600 py-5">Категории квартир</h2>
        </div>
        <div class="row gy-5 g-lg-5 mb-4">
            {% for category in parent_categories %}
            <div class="col-md-4 mb-3">
               <a href="?category={{ category.id }}" class="recent-work card border-0 shadow-lg overflow-hidden">
                    <img class="recent-work-img card-img" src="{{ category.image.url }}" alt="Категория"
                         style="width: 100%; height: 200px; object-fit: cover;">
                    <div class="recent-work-vertical card-img-overlay d-flex align-items-end">
                        <div class="recent-work-content text-start mb-3 ml-3 text-dark">
                            <h3 class="card-title light-300">{{ category.title }}</h3>
                            <p class="card-text">Смотреть квартиры</p>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- Услуги -->
<section class="service-wrapper py-3">
    <div class="container-fluid pb-3">
        <div class="row">
            <h2 class="h2 text-center col-12 py-5 semi-bold-600">Наши услуги</h2>
            <div class="service-header col-2 col-lg-3 text-end light-300">
                <i class='bx bx-key h3 mt-1'></i>
            </div>
            <div class="service-heading col-10 col-lg-9 text-start float-end light-300">
                <h2 class="h3 pb-4 typo-space-line">Поможем купить и арендовать квартиры</h2>
            </div>
        </div>
        <p class="service-footer col-10 offset-2 col-lg-9 offset-lg-3 text-start pb-3 text-muted px-2">
            Мы подберём жильё под ваши пожелания: район, планировка, цена и инфраструктура.
            Работаем с проверенными объектами недвижимости.
        </p>
    </div>

    <!-- Фильтр по категориям -->
    <div class="service-tag py-5 bg-secondary">
        <div class="container">
            <ul class="nav justify-content-center flex-wrap">
                <!-- Все -->
                <li class="nav-item mx-2 mb-2">
                    <a class="btn btn-outline-light shadow rounded-pill px-4 {% if not request.GET.category %}border-3 fw-bold{% endif %}"
                       href="{% url 'index' %}">
                        Все
                    </a>
                </li>
                {% for category in categories %}
                <li class="nav-item mx-2 mb-2">
                    <a href="?category={{ category.id }}"
                       class="btn btn-outline-light shadow rounded-pill px-4 {% if request.GET.category == category.id|stringformat:"s" %}border-3 fw-bold{% endif %}">
                        {{ category.title }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</section>

<!-- Карточки квартир -->
<style>
    .estate-card {
        border-radius: 1rem;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .estate-card:hover { transform: translateY(-5px); }
    .estate-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .estate-card .card-body {
        padding: 1rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .estate-card h5 { margin: 0 0 0.5rem; font-size: 1.1rem; }
    .estate-card p { margin: 0; font-size: 1rem; color: #333; }
    .estate-card a {
        margin-top: 0.8rem;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        background-color: #343a40;
        color: white;
        border-radius: 999px;
        text-decoration: none;
        text-align: center;
    }
    .estate-card a:hover { background-color: #212529; }
</style>

<section class="container overflow-hidden py-5">
    <div class="row gx-4 gy-4">
{% for item in estates_with_likes %}
  <div class="col-sm-6 col-md-4 col-lg-3 mb-4">
    <div class="card estate-card h-100">
      <div class="position-relative">
        <img src="{{ item.estate.cover.url }}" class="card-img-top" alt="{{ item.estate.title }}">
        <button type="button" class="btn btn-sm position-absolute top-0 end-0 m-2 like-btn" style="border-radius: 50%; background: transparent; border: none;">
          {% if item.liked %}
            <i class="bx bxs-heart" style="color: red; font-size: 1.5rem;"></i>  {# заполненное сердечко #}
          {% else %}
            <i class="bx bx-heart" style="color: red; font-size: 1.5rem;"></i>   {# пустое сердечко #}
          {% endif %}
        </button>
      </div>
      <div class="card-body d-flex flex-column">
        <h5 class="card-title">{{ item.estate.title }}</h5>
        <p class="card-text mb-3">{{ item.estate.price }} сом</p>
        <a href="{% url 'detail' item.estate.id %}" class="btn btn-primary mt-auto">Подробнее</a>
      </div>
    </div>
  </div>
{% endfor %}


<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.querySelectorAll('.like-btn').forEach(button => {
  button.addEventListener('click', function() {
    const estateId = this.closest('.estate-card').querySelector('a.btn-primary').href.split('/').slice(-2, -1)[0];
    fetch("{% url 'toggle_like' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: `estate_id=${estateId}`
    })
    .then(response => response.json())
    .then(data => {
      if(data.liked) {
        this.innerHTML = '<i class="bx bxs-heart" style="color: red; font-size: 1.5rem;"></i>'; // заполненное сердце
      } else {
        this.innerHTML = '<i class="bx bx-heart" style="color: red; font-size: 1.5rem;"></i>'; // пустое сердце
      }
    })
    .catch(error => console.error('Error:', error));
  });
});
</script>


{% endblock %}
