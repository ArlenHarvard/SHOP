{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
    <h1 class="text-center mb-4">Все квартиры и дома</h1>

    <!-- Форма фильтрации -->
    <form method="get" class="mb-4">
        <div class="row g-2">
            <div class="col-md-3">
                <select name="category" class="form-select">
                    <option value="">Все категории</option>
                    {% for category in parent_categories %}
                        <option value="{{ category.id }}" {% if current_category and current_category.id == category.id %}selected{% endif %}>
                            {{ category.title }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" name="min_price" class="form-control" placeholder="Цена от" value="{{ min_price }}">
            </div>
            <div class="col-md-2">
                <input type="number" name="max_price" class="form-control" placeholder="Цена до" value="{{ max_price }}">
            </div>
            <div class="col-md-3">
<select name="city" class="form-select">
    <option value="">Все города</option>
    {% for c in cities %}
        <option value="{{ c.id }}" {% if selected_city|default:'' == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.title }}
        </option>
    {% endfor %}
</select>

            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">Фильтр</button>
            </div>
        </div>
    </form>

    <!-- Список недвижимости -->
    <div class="row">
        {% for item in estates_with_likes %}
            {% with estate=item.estate %}
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100">
                        <img src="{{ estate.cover.url }}" class="card-img-top" alt="{{ estate.title }}">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ estate.title }}</h5>
                            <p class="card-text">
                                {{ estate.descriptions|truncatewords:20 }}
                                <br>
                                <strong>Цена: {{ estate.price }} сом</strong><br>
                                <small class="text-muted">Город: {{ estate.city }}</small>
                            </p>
                            <div class="mt-auto">
                                <a href="{% url 'detail' estate.id %}" class="btn btn-sm btn-primary">Подробнее</a>
                            </div>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% empty %}
            <p class="text-center">Нет объектов, соответствующих фильтрам.</p>
        {% endfor %}
    </div>

    <!-- Пагинация -->
    <div class="d-flex justify-content-center mt-4">
        <nav>
            <ul class="pagination">

                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if current_category %}category={{ current_category.id }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if selected_city %}city={{ selected_city }}&{% endif %}page={{ page_obj.previous_page_number }}">«</a>
                    </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                        <a class="page-link" href="?{% if current_category %}category={{ current_category.id }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if selected_city %}city={{ selected_city }}&{% endif %}page={{ num }}">{{ num }}</a>
                    </li>
                {% endfor %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?{% if current_category %}category={{ current_category.id }}&{% endif %}{% if min_price %}min_price={{ min_price }}&{% endif %}{% if max_price %}max_price={{ max_price }}&{% endif %}{% if selected_city %}city={{ selected_city }}&{% endif %}page={{ page_obj.next_page_number }}">»</a>
                    </li>
                {% endif %}

            </ul>
        </nav>
    </div>
</div>
{% endblock %}
